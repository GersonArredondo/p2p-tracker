<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="theme-color" content="#F2F2F7">
<title>P2P Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  /* Apple system colors */
  --bg:          #F2F2F7;
  --bg2:         #FFFFFF;
  --bg3:         #F2F2F7;
  --label:       #000000;
  --label2:      #3C3C43;
  --label3:      #3C3C4399;
  --label4:      #3C3C432E;
  --separator:   #C6C6C8;
  --blue:        #007AFF;
  --green:       #34C759;
  --red:         #FF3B30;
  --orange:      #FF9500;
  --gray:        #8E8E93;
  --gray2:       #AEAEB2;
  --gray3:       #C7C7CC;
  --gray4:       #D1D1D6;
  --gray5:       #E5E5EA;
  --gray6:       #F2F2F7;
  --gold:        #FF9F0A;
  --fill:        rgba(120,120,128,0.12);
  --fill2:       rgba(120,120,128,0.08);
  --radius:      12px;
  --radius-lg:   16px;
  --radius-xl:   20px;
  --font:        'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html, body { height:100%; background:var(--bg); overflow:hidden; }
body { font-family:var(--font); color:var(--label); max-width:430px; margin:0 auto;
  display:flex; flex-direction:column; position:relative; }

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen { position:absolute; inset:0; background:var(--bg);
  display:flex; flex-direction:column; overflow:hidden;
  transition:transform .32s cubic-bezier(.4,0,.2,1), opacity .32s; will-change:transform; }
.screen.hidden  { transform:translateX(100%); pointer-events:none; }
.screen.back    { transform:translateX(-28%); opacity:0; pointer-events:none; }

/* ‚îÄ‚îÄ NAV BAR (Apple style) ‚îÄ‚îÄ */
.navbar {
  background:rgba(242,242,247,0.85);
  backdrop-filter:blur(20px);
  -webkit-backdrop-filter:blur(20px);
  padding:52px 20px 12px;
  display:flex; align-items:center; justify-content:space-between;
  border-bottom:0.5px solid var(--separator);
  flex-shrink:0; position:relative;
}
.navbar-title { font-size:17px; font-weight:600; letter-spacing:-0.4px; position:absolute;
  left:50%; transform:translateX(-50%); }
.navbar-btn { font-size:17px; color:var(--blue); font-weight:400; cursor:pointer;
  padding:4px 0; min-width:44px; }
.navbar-btn.right { text-align:right; }
.navbar-btn.destructive { color:var(--red); }
.navbar-large-title { font-size:34px; font-weight:700; letter-spacing:-0.5px; padding:8px 20px 16px;
  background:var(--bg); flex-shrink:0; }

/* ‚îÄ‚îÄ SCROLL CONTENT ‚îÄ‚îÄ */
.content { flex:1; overflow-y:auto; padding:0 0 80px; scrollbar-width:none; -webkit-overflow-scrolling:touch; }
.content::-webkit-scrollbar { display:none; }

/* ‚îÄ‚îÄ APPLE TABLE GROUPS ‚îÄ‚îÄ */
.group { margin:28px 16px 0; }
.group:first-child { margin-top:16px; }
.group-label { font-size:13px; font-weight:400; color:var(--gray); letter-spacing:-.1px;
  text-transform:uppercase; margin-bottom:8px; padding:0 4px; }
.group-footer { font-size:13px; color:var(--gray); margin-top:8px; padding:0 4px; line-height:1.5; }
.table { background:var(--bg2); border-radius:var(--radius-lg); overflow:hidden; }
.row { display:flex; align-items:center; padding:0 16px;
  min-height:44px; border-bottom:0.5px solid var(--separator); position:relative; }
.row:last-child { border-bottom:none; }
.row-icon { width:28px; height:28px; border-radius:6px; display:flex; align-items:center;
  justify-content:center; font-size:15px; margin-right:12px; flex-shrink:0; }
.row-label { font-size:17px; flex:1; letter-spacing:-.2px; }
.row-value { font-size:17px; color:var(--gray); text-align:right; }
.row-chevron { color:var(--gray3); font-size:13px; margin-left:6px; }
.row-input { flex:1; border:none; outline:none; background:transparent; font-size:17px;
  font-family:var(--font); color:var(--label); padding:12px 0; width:100%; }
.row-input::placeholder { color:var(--gray3); }

/* ‚îÄ‚îÄ SEGMENTED CONTROL (tipo) ‚îÄ‚îÄ */
.segmented { display:flex; background:var(--fill); border-radius:9px; padding:2px; margin:16px; }
.seg-btn { flex:1; padding:8px; text-align:center; border-radius:7px; font-size:14px;
  font-weight:500; color:var(--gray); cursor:pointer; transition:all .2s; }
.seg-btn.active { background:var(--bg2); color:var(--label); font-weight:600;
  box-shadow:0 1px 3px rgba(0,0,0,.12), 0 1px 2px rgba(0,0,0,.08); }

/* ‚îÄ‚îÄ DOC TYPE ‚îÄ‚îÄ */
.doc-row { display:flex; gap:8px; padding:8px 16px 12px; background:var(--bg2); }
.doc-btn { flex:1; padding:7px 4px; border-radius:8px; text-align:center; font-size:13px;
  font-weight:500; color:var(--gray); background:var(--fill); cursor:pointer; transition:all .15s; }
.doc-btn.active { background:var(--blue); color:white; }

/* ‚îÄ‚îÄ TOGGLE TERCERO ‚îÄ‚îÄ */
.tercero-toggle { display:flex; gap:0; background:var(--bg2); border-radius:var(--radius-lg);
  overflow:hidden; }
.terc-opt { flex:1; padding:14px 12px; text-align:center; cursor:pointer; transition:all .2s;
  border-right:0.5px solid var(--separator); }
.terc-opt:last-child { border-right:none; }
.terc-opt-icon { font-size:20px; }
.terc-opt-label { font-size:12px; font-weight:500; color:var(--gray); margin-top:3px; }
.terc-opt.active-no  { background:var(--fill2); }
.terc-opt.active-no .terc-opt-label  { color:var(--label); }
.terc-opt.active-si  { background:var(--gold); }
.terc-opt.active-si .terc-opt-label  { color:white; font-weight:600; }

/* ‚îÄ‚îÄ TERCERO FIELDS ‚îÄ‚îÄ */
.tercero-fields { animation:fadeIn .2s ease; }
.tercero-fields.hidden { display:none; }
@keyframes fadeIn { from{opacity:0;transform:translateY(-6px)} to{opacity:1;transform:translateY(0)} }

/* ‚îÄ‚îÄ VENTA NOTE ‚îÄ‚îÄ */
.venta-note { background:rgba(0,122,255,0.08); border-radius:var(--radius);
  padding:12px 14px; margin:0 16px; display:flex; gap:10px; align-items:center; }
.venta-note-text { font-size:13px; color:var(--blue); line-height:1.5; }
.venta-note.hidden { display:none; }

/* ‚îÄ‚îÄ SUBMIT BUTTON ‚îÄ‚îÄ */
.submit-wrap { padding:24px 16px 12px; }
.submit-btn { width:100%; background:var(--blue); color:white; border:none;
  border-radius:var(--radius-lg); padding:16px; font-size:17px; font-weight:600;
  font-family:var(--font); cursor:pointer; letter-spacing:-.2px;
  transition:opacity .15s; }
.submit-btn:active { opacity:.7; }
.submit-btn:disabled { opacity:.4; cursor:not-allowed; }

/* ‚îÄ‚îÄ BOTTOM TAB BAR ‚îÄ‚îÄ */
.tabbar { position:absolute; bottom:0; left:0; right:0;
  background:rgba(242,242,247,0.92); backdrop-filter:blur(20px);
  -webkit-backdrop-filter:blur(20px);
  border-top:0.5px solid var(--separator);
  padding:8px 0 max(16px,env(safe-area-inset-bottom));
  display:flex; justify-content:space-around; z-index:100; }
.tab { display:flex; flex-direction:column; align-items:center; gap:2px;
  cursor:pointer; padding:4px 20px; }
.tab-icon { font-size:22px; color:var(--gray2); }
.tab-label { font-size:10px; color:var(--gray2); font-weight:500; }
.tab.active .tab-icon { color:var(--blue); }
.tab.active .tab-label { color:var(--blue); }

/* ‚îÄ‚îÄ HISTORIAL ‚îÄ‚îÄ */
.seg-bar { background:rgba(242,242,247,0.9); backdrop-filter:blur(10px);
  padding:8px 16px 10px; border-bottom:0.5px solid var(--separator); flex-shrink:0; }
.subpanel { display:none; flex:1; flex-direction:column; overflow:hidden; }
.subpanel.active { display:flex; }

/* Search bar */
.search-wrap { padding:8px 16px 10px; background:var(--bg); flex-shrink:0; }
.search-field { background:var(--fill); border-radius:10px; padding:9px 14px;
  display:flex; align-items:center; gap:8px; }
.search-field input { background:none; border:none; outline:none; font-size:15px;
  font-family:var(--font); color:var(--label); flex:1; }
.search-field input::placeholder { color:var(--gray2); }
.search-icon { color:var(--gray2); font-size:14px; }

.list-content { flex:1; overflow-y:auto; scrollbar-width:none; }
.list-content::-webkit-scrollbar { display:none; }

/* Order row (list style) */
.order-row { background:var(--bg2); display:flex; align-items:center; padding:12px 16px;
  border-bottom:0.5px solid var(--separator); cursor:pointer; gap:12px; }
.order-row:active { background:var(--gray5); }
.order-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.order-dot.c { background:var(--green); }
.order-dot.v { background:var(--red); }
.order-main { flex:1; display:flex; flex-direction:column; gap:2px; }
.order-name { font-size:16px; font-weight:500; letter-spacing:-.2px; }
.order-meta { font-size:13px; color:var(--gray); }
.order-right { display:flex; flex-direction:column; align-items:flex-end; gap:3px; }
.order-badge { font-size:11px; font-weight:600; padding:2px 8px; border-radius:20px; }
.order-badge.c { background:rgba(52,199,89,.12); color:var(--green); }
.order-badge.v { background:rgba(255,59,48,.1); color:var(--red); }
.order-date { font-size:12px; color:var(--gray2); }

/* Edit overlay */
.edit-overlay { position:absolute; inset:0; background:var(--bg);
  display:flex; flex-direction:column; overflow:hidden; z-index:20;
  animation:slideUp .25s ease; }
.edit-overlay.hidden { display:none; }
@keyframes slideUp { from{transform:translateY(8px);opacity:0} to{transform:translateY(0);opacity:1} }

.edit-scroll { flex:1; overflow-y:auto; scrollbar-width:none; padding-bottom:20px; }
.edit-scroll::-webkit-scrollbar { display:none; }

.delete-btn-row { margin:28px 16px 0; }
.delete-btn { width:100%; background:var(--bg2); color:var(--red); border:none;
  border-radius:var(--radius-lg); padding:14px; font-size:17px; font-weight:400;
  font-family:var(--font); cursor:pointer; letter-spacing:-.2px; }
.delete-btn:active { opacity:.7; }

/* ‚îÄ‚îÄ CONFIG SCREEN ‚îÄ‚îÄ */
.danger-btn { width:100%; background:var(--bg2); color:var(--red); border:none;
  border-radius:var(--radius-lg); padding:14px; font-size:17px; font-weight:400;
  font-family:var(--font); cursor:pointer; text-align:center; display:block; }
.danger-btn:active { opacity:.7; }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast { position:fixed; bottom:110px; left:50%; transform:translateX(-50%) translateY(10px);
  background:rgba(50,50,50,.92); backdrop-filter:blur(10px);
  color:white; border-radius:var(--radius); padding:11px 20px;
  font-size:14px; font-weight:500; white-space:nowrap; opacity:0;
  transition:all .3s cubic-bezier(.4,0,.2,1); z-index:999; max-width:85%; text-align:center; }
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.empty { display:flex; flex-direction:column; align-items:center; justify-content:center;
  padding:60px 32px; gap:12px; }
.empty-icon { font-size:44px; opacity:.25; }
.empty-title { font-size:17px; font-weight:600; color:var(--label2); }
.empty-sub { font-size:15px; color:var(--gray); text-align:center; line-height:1.5; }

/* Status dot */
.status-row { display:flex; align-items:center; gap:8px; }
.sdot { width:8px; height:8px; border-radius:50%; background:var(--gray3); flex-shrink:0; }
.sdot.ok { background:var(--green); }
.sdot.warn { background:var(--orange); }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 1 ‚Äî NUEVA ORDEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="sc-nueva">
  <div class="navbar">
    <div class="navbar-btn" style="min-width:44px"></div>
    <div class="navbar-title">Nueva Orden</div>
    <div class="navbar-btn right" style="color:var(--gray);font-size:13px" id="nueva-sub">COMPRA</div>
  </div>

  <div class="content" id="form-content">

    <!-- Tipo -->
    <div class="segmented">
      <div class="seg-btn active" id="seg-compra" onclick="setTipo('COMPRA')">üì• Compra</div>
      <div class="seg-btn" id="seg-venta" onclick="setTipo('VENTA')">üì§ Venta</div>
    </div>

    <!-- N¬∞ Orden -->
    <div class="group">
      <div class="group-label">Orden Binance</div>
      <div class="table">
        <div class="row">
          <input class="row-input" id="f-orden" type="text" placeholder="Ej: 20250224-0041" autocomplete="off">
        </div>
      </div>
    </div>

    <!-- Titular Exchange -->
    <div class="group">
      <div class="group-label">Titular del Exchange</div>
      <div class="table">
        <div class="row">
          <input class="row-input" id="f-exch-nombre" type="text" placeholder="Nombre en Binance" autocomplete="off">
        </div>
        <div class="doc-row" id="doc-exch-row">
          <div class="doc-btn" onclick="setDoc('exch','CC',this)">CC</div>
          <div class="doc-btn" onclick="setDoc('exch','CE',this)">CE</div>
          <div class="doc-btn" onclick="setDoc('exch','PPT',this)">PPT</div>
          <div class="doc-btn" onclick="setDoc('exch','SD',this)">SD</div>
        </div>
        <div class="row">
          <input class="row-input" id="f-exch-doc" type="text" placeholder="N√∫mero de documento" autocomplete="off" inputmode="text">
        </div>
      </div>
      <div class="group-footer">Nombre y documento tal como aparece en Binance.</div>
    </div>

    <!-- Tercero (solo COMPRA) -->
    <div id="tercero-section">
      <div class="group">
        <div class="group-label">¬øHay tercero?</div>
        <div class="tercero-toggle">
          <div class="terc-opt active-no" id="tog-no" onclick="setTercero(false)">
            <div class="terc-opt-icon">üö´</div>
            <div class="terc-opt-label">No</div>
          </div>
          <div class="terc-opt" id="tog-si" onclick="setTercero(true)">
            <div class="terc-opt-icon">üë•</div>
            <div class="terc-opt-label">S√≠</div>
          </div>
        </div>
      </div>

      <div class="tercero-fields hidden" id="tercero-fields">
        <div class="group">
          <div class="group-label">Datos del Tercero</div>
          <div class="table">
            <div class="row">
              <input class="row-input" id="f-terc-nombre" type="text" placeholder="Nombre del tercero" autocomplete="off">
            </div>
            <div class="doc-row">
              <div class="doc-btn" onclick="setDoc('terc','CC',this)">CC</div>
              <div class="doc-btn" onclick="setDoc('terc','CE',this)">CE</div>
              <div class="doc-btn" onclick="setDoc('terc','PPT',this)">PPT</div>
              <div class="doc-btn" onclick="setDoc('terc','SD',this)">SD</div>
            </div>
            <div class="row">
              <input class="row-input" id="f-terc-doc" type="text" placeholder="N√∫mero de documento" autocomplete="off" inputmode="text">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Venta note -->
    <div class="venta-note hidden" id="venta-note">
      <span style="font-size:16px">‚ÑπÔ∏è</span>
      <div class="venta-note-text">En ventas solo se registra el titular del Exchange.</div>
    </div>

    <!-- Bot√≥n guardar dentro del scroll -->
    <div class="submit-wrap">
      <button class="submit-btn" id="submit-btn" onclick="submitOrder()">Guardar</button>
    </div>

  </div><!-- end form-content -->

  <div class="tabbar">
    <div class="tab active" onclick="goTo('sc-nueva','tab-nueva')">
      <div class="tab-icon">‚úö</div><div class="tab-label">Nueva</div>
    </div>
    <div class="tab" onclick="goTo('sc-historial','tab-hist')">
      <div class="tab-icon">üìã</div><div class="tab-label">Historial</div>
    </div>
    <div class="tab" onclick="goTo('sc-config','tab-cfg')">
      <div class="tab-icon">‚öôÔ∏è</div><div class="tab-label">Ajustes</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 2 ‚Äî HISTORIAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen hidden" id="sc-historial">
  <div class="navbar">
    <div class="navbar-btn" style="min-width:44px"></div>
    <div class="navbar-title">Historial</div>
    <div class="navbar-btn right" style="min-width:44px"></div>
  </div>

  <div class="seg-bar">
    <div class="segmented" style="margin:0">
      <div class="seg-btn active" id="ht-lista" onclick="setHistTab('lista')">√ìrdenes</div>
      <div class="seg-btn" id="ht-buscar" onclick="setHistTab('buscar')">Buscar / Editar</div>
    </div>
  </div>

  <!-- Sub: Lista -->
  <div class="subpanel active" id="hp-lista">
    <div class="list-content" id="hist-list">
      <div class="empty">
        <div class="empty-icon">üìã</div>
        <div class="empty-title">Sin √≥rdenes</div>
        <div class="empty-sub">Las √≥rdenes que registres aparecer√°n aqu√≠.</div>
      </div>
    </div>
  </div>

  <!-- Sub: Buscar -->
  <div class="subpanel" id="hp-buscar" style="position:relative;">
    <div class="search-wrap">
      <div class="search-field">
        <span class="search-icon">üîç</span>
        <input type="text" placeholder="N¬∞ orden, nombre, documento..." id="search-input" oninput="doSearch()">
      </div>
    </div>
    <div class="list-content" id="search-list"></div>

    <!-- Edit overlay -->
    <div class="edit-overlay hidden" id="edit-overlay">
      <div class="navbar" style="position:relative;">
        <div class="navbar-btn" onclick="closeEdit()">‚Üê Atr√°s</div>
        <div class="navbar-title">Editar orden</div>
        <div class="navbar-btn right destructive" onclick="deleteFromEdit()">Eliminar</div>
      </div>
      <div class="edit-scroll" id="edit-scroll"></div>
    </div>
  </div>

  <div class="tabbar">
    <div class="tab" onclick="goTo('sc-nueva','tab-nueva')">
      <div class="tab-icon">‚úö</div><div class="tab-label">Nueva</div>
    </div>
    <div class="tab active" onclick="goTo('sc-historial','tab-hist')">
      <div class="tab-icon">üìã</div><div class="tab-label">Historial</div>
    </div>
    <div class="tab" onclick="goTo('sc-config','tab-cfg')">
      <div class="tab-icon">‚öôÔ∏è</div><div class="tab-label">Ajustes</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 3 ‚Äî CONFIG
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen hidden" id="sc-config">
  <div class="navbar">
    <div class="navbar-btn" style="min-width:44px"></div>
    <div class="navbar-title">Ajustes</div>
    <div class="navbar-btn right" style="min-width:44px"></div>
  </div>
  <div class="content">

    <div class="group">
      <div class="group-label">Google Sheets</div>
      <div class="table">
        <div class="row">
          <div class="row-label">Estado</div>
          <div class="row-value">
            <div class="status-row">
              <div class="sdot" id="sdot"></div>
              <span id="stext" style="font-size:14px;color:var(--gray)">Sin configurar</span>
            </div>
          </div>
        </div>
        <div class="row" style="flex-direction:column;align-items:flex-start;padding:12px 16px;">
          <div style="font-size:13px;color:var(--gray);margin-bottom:6px;">URL del Apps Script</div>
          <input class="row-input" id="cfg-url" type="url"
            placeholder="https://script.google.com/macros/s/..."
            style="font-size:14px;color:var(--label);padding:0;">
        </div>
        <div class="row" style="padding:0 16px 0 0;">
          <div class="row-label" style="padding:14px 16px;color:var(--blue);cursor:pointer;font-weight:500;"
            onclick="saveConfig()">Guardar y verificar</div>
        </div>
      </div>
    </div>

    <div class="group">
      <div class="group-label">Datos</div>
      <div class="table">
        <div class="row">
          <div class="row-label">√ìrdenes guardadas</div>
          <div class="row-value" id="cfg-count">0</div>
        </div>
      </div>
    </div>

    <div class="group">
      <div class="group-label">Zona de peligro</div>
      <div class="table">
        <div class="row" style="cursor:pointer;" onclick="deleteLastOrder()">
          <div class="row-label" style="color:var(--orange);">Eliminar √∫ltima orden registrada</div>
          <div class="row-chevron">‚Ä∫</div>
        </div>
        <div class="row" style="cursor:pointer;" onclick="deleteAllOrders()">
          <div class="row-label" style="color:var(--red);">Eliminar todas las √≥rdenes</div>
          <div class="row-chevron">‚Ä∫</div>
        </div>
      </div>
      <div class="group-footer">Eliminar tambi√©n borrar√° las filas correspondientes en Google Sheets.</div>
    </div>

  </div>

  <div class="tabbar">
    <div class="tab" onclick="goTo('sc-nueva','tab-nueva')">
      <div class="tab-icon">‚úö</div><div class="tab-label">Nueva</div>
    </div>
    <div class="tab" onclick="goTo('sc-historial','tab-hist')">
      <div class="tab-icon">üìã</div><div class="tab-label">Historial</div>
    </div>
    <div class="tab active" onclick="goTo('sc-config','tab-cfg')">
      <div class="tab-icon">‚öôÔ∏è</div><div class="tab-label">Ajustes</div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE & STORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ORDERS_KEY = 'p2p_v5_orders';
const CONFIG_KEY = 'p2p_v5_config';

const ST = { tipo:'COMPRA', exchDoc:'', tercDoc:'', hasTercero:false, editingId:null };

function getOrders() {
  try { return JSON.parse(localStorage.getItem(ORDERS_KEY) || '[]'); } catch { return []; }
}
function saveOrders(o) { localStorage.setItem(ORDERS_KEY, JSON.stringify(o)); }
function getConfig() {
  try { return JSON.parse(localStorage.getItem(CONFIG_KEY) || '{}'); } catch { return {}; }
}
function saveConfigData(c) { localStorage.setItem(CONFIG_KEY, JSON.stringify(c)); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let curScreen = 'sc-nueva';

function goTo(id, tabId) {
  if (curScreen === id) return;
  document.getElementById(curScreen).classList.add('back');
  const next = document.getElementById(id);
  next.classList.remove('hidden','back');
  curScreen = id;
  if (id === 'sc-nueva')    { resetForm(); }
  if (id === 'sc-historial'){ refreshHistorial(); }
  if (id === 'sc-config')   { loadConfig(); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FORM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setTipo(tipo) {
  ST.tipo = tipo;
  const isC = tipo === 'COMPRA';
  document.getElementById('seg-compra').classList.toggle('active', isC);
  document.getElementById('seg-venta').classList.toggle('active', !isC);
  document.getElementById('nueva-sub').textContent = tipo;
  document.getElementById('tercero-section').style.display = isC ? '' : 'none';
  document.getElementById('venta-note').classList.toggle('hidden', isC);
}

function setDoc(group, val, el) {
  const parent = el.parentElement;
  parent.querySelectorAll('.doc-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  if (group === 'exch') ST.exchDoc = val;
  else ST.tercDoc = val;
}

function setTercero(has) {
  ST.hasTercero = has;
  document.getElementById('tog-si').className = `terc-opt ${has ? 'active-si' : ''}`;
  document.getElementById('tog-no').className = `terc-opt ${!has ? 'active-no' : ''}`;
  document.getElementById('tercero-fields').classList.toggle('hidden', !has);
}

function resetForm() {
  ST.tipo = 'COMPRA'; ST.exchDoc = ''; ST.tercDoc = ''; ST.hasTercero = false;
  ['f-orden','f-exch-nombre','f-exch-doc','f-terc-nombre','f-terc-doc']
    .forEach(id => { const el = document.getElementById(id); if(el) el.value = ''; });
  document.querySelectorAll('.doc-btn').forEach(b => b.classList.remove('active'));
  setTipo('COMPRA');
  setTercero(false);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUBMIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function submitOrder() {
  const orden      = document.getElementById('f-orden').value.trim();
  const exchNombre = document.getElementById('f-exch-nombre').value.trim();
  const exchDocNum = document.getElementById('f-exch-doc').value.trim();

  if (!orden)      { showToast('Ingresa el N¬∞ de orden'); return; }
  if (!exchNombre) { showToast('Ingresa el nombre del titular'); return; }
  if (!ST.exchDoc) { showToast('Selecciona el tipo de documento'); return; }
  if (!exchDocNum) { showToast('Ingresa el n√∫mero de documento'); return; }

  if (ST.hasTercero) {
    if (!document.getElementById('f-terc-nombre').value.trim()) { showToast('Ingresa el nombre del tercero'); return; }
    if (!ST.tercDoc) { showToast('Selecciona el tipo de doc del tercero'); return; }
    if (!document.getElementById('f-terc-doc').value.trim()) { showToast('Ingresa el N¬∞ de doc del tercero'); return; }
  }

  const orders = getOrders();
  if (orders.find(o => o.orden === orden)) { showToast('Esta orden ya fue registrada'); return; }

  const order = {
    id:          Date.now(),
    fecha:       formatDate(new Date()),
    orden,
    tipo:        ST.tipo,
    exchNombre,
    exchDocTipo: ST.exchDoc,
    exchDocNum,
    hayTercero:  ST.hasTercero ? 'S√≠' : 'No',
    tercNombre:  ST.hasTercero ? document.getElementById('f-terc-nombre').value.trim() : '',
    tercDocTipo: ST.hasTercero ? ST.tercDoc : '',
    tercDocNum:  ST.hasTercero ? document.getElementById('f-terc-doc').value.trim() : '',
  };

  orders.unshift(order);
  saveOrders(orders);

  document.getElementById('submit-btn').disabled = true;
  showToast('Guardando...');

  const cfg = getConfig();
  if (cfg.scriptUrl) {
    try {
      await sendToSheets('append', order, cfg.scriptUrl);
      showToast('‚úì Guardado en Google Sheets');
    } catch { showToast('‚úì Guardado localmente'); }
  } else {
    showToast('‚úì Guardado');
  }

  document.getElementById('submit-btn').disabled = false;
  resetForm();
}

async function sendToSheets(action, order, url) {
  const row = [order.fecha, order.orden, order.tipo,
    order.exchNombre, order.exchDocTipo, order.exchDocNum,
    order.hayTercero, order.tercNombre, order.tercDocTipo, order.tercDocNum];
  await fetch(url, {
    method:'POST', mode:'no-cors',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({action, row, orden: order.orden})
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORIAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function refreshHistorial() {
  renderList(getOrders());
  renderSearchResults(getOrders());
}

function setHistTab(tab) {
  ['lista','buscar'].forEach(t => {
    document.getElementById(`ht-${t}`).classList.toggle('active', t===tab);
    document.getElementById(`hp-${t}`).classList.toggle('active', t===tab);
  });
  if (tab !== 'buscar') closeEdit();
}

function renderList(orders) {
  const el = document.getElementById('hist-list');
  if (!orders.length) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">üìã</div>
      <div class="empty-title">Sin √≥rdenes</div>
      <div class="empty-sub">Las √≥rdenes que registres aparecer√°n aqu√≠.</div></div>`;
    return;
  }
  el.innerHTML = orders.map(orderRowHTML).join('');
}

function orderRowHTML(o) {
  const isC = o.tipo === 'COMPRA';
  return `<div class="order-row" onclick="openEdit(${o.id})">
    <div class="order-dot ${isC?'c':'v'}"></div>
    <div class="order-main">
      <div class="order-name">${o.exchNombre}</div>
      <div class="order-meta">${o.exchDocTipo} ${o.exchDocNum}${o.hayTercero==='S√≠'?' ¬∑ üë• '+o.tercNombre:''}</div>
    </div>
    <div class="order-right">
      <span class="order-badge ${isC?'c':'v'}">${o.tipo}</span>
      <div class="order-date">${o.fecha}</div>
    </div>
  </div>`;
}

function doSearch() {
  const q = document.getElementById('search-input').value.toLowerCase().trim();
  const orders = getOrders();
  const filtered = q ? orders.filter(o =>
    o.orden.toLowerCase().includes(q) ||
    o.exchNombre.toLowerCase().includes(q) ||
    o.exchDocNum.toLowerCase().includes(q) ||
    o.tercNombre.toLowerCase().includes(q) ||
    o.tercDocNum.toLowerCase().includes(q)
  ) : orders;
  renderSearchResults(filtered);
}

function renderSearchResults(orders) {
  const el = document.getElementById('search-list');
  if (!orders.length) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">üîç</div>
      <div class="empty-title">Sin resultados</div></div>`;
    return;
  }
  el.innerHTML = orders.map(orderRowHTML).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EDIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openEdit(id) {
  const o = getOrders().find(x => x.id === id);
  if (!o) return;
  ST.editingId = id;
  ST.editExchDoc = o.exchDocTipo;
  ST.editTercDoc = o.tercDocTipo;

  document.getElementById('edit-scroll').innerHTML = `
    <div class="group" style="margin-top:16px">
      <div class="group-label">Orden</div>
      <div class="table">
        <div class="row"><div class="row-label">N¬∞ Orden</div><div class="row-value">${o.orden}</div></div>
        <div class="row"><div class="row-label">Tipo</div>
          <div class="row-value" style="color:${o.tipo==='COMPRA'?'var(--green)':'var(--red)'}">${o.tipo}</div></div>
        <div class="row"><div class="row-label">Fecha</div><div class="row-value">${o.fecha}</div></div>
      </div>
    </div>
    <div class="group">
      <div class="group-label">Titular Exchange</div>
      <div class="table">
        <div class="row"><input class="row-input" id="ef-exch-nombre" value="${o.exchNombre}" placeholder="Nombre"></div>
        <div class="doc-row">
          ${['CC','CE','PPT','SD'].map(t=>`<div class="doc-btn ${o.exchDocTipo===t?'active':''}"
            onclick="editDocSel('exch','${t}',this)">${t}</div>`).join('')}
        </div>
        <div class="row"><input class="row-input" id="ef-exch-doc" value="${o.exchDocNum}" placeholder="N¬∞ documento"></div>
      </div>
    </div>
    ${o.tipo==='COMPRA' ? `
    <div class="group">
      <div class="group-label">Tercero</div>
      <div class="table">
        <div class="row"><input class="row-input" id="ef-terc-nombre" value="${o.tercNombre}" placeholder="Nombre (opcional)"></div>
        <div class="doc-row">
          ${['CC','CE','PPT','SD'].map(t=>`<div class="doc-btn ${o.tercDocTipo===t?'active':''}"
            onclick="editDocSel('terc','${t}',this)">${t}</div>`).join('')}
        </div>
        <div class="row"><input class="row-input" id="ef-terc-doc" value="${o.tercDocNum}" placeholder="N¬∞ documento (opcional)"></div>
      </div>
    </div>` : ''}
    <div class="group">
      <div class="table">
        <div class="row" style="cursor:pointer;" onclick="saveEdit()">
          <div class="row-label" style="color:var(--blue);font-weight:500;text-align:center;width:100%">Guardar cambios</div>
        </div>
      </div>
    </div>
  `;
  document.getElementById('edit-overlay').classList.remove('hidden');
}

function editDocSel(group, val, el) {
  el.parentElement.querySelectorAll('.doc-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  if (group === 'exch') ST.editExchDoc = val;
  else ST.editTercDoc = val;
}

function saveEdit() {
  const orders = getOrders();
  const idx = orders.findIndex(x => x.id === ST.editingId);
  if (idx === -1) return;
  orders[idx].exchNombre  = document.getElementById('ef-exch-nombre')?.value.trim() || orders[idx].exchNombre;
  orders[idx].exchDocTipo = ST.editExchDoc;
  orders[idx].exchDocNum  = document.getElementById('ef-exch-doc')?.value.trim() || orders[idx].exchDocNum;
  if (orders[idx].tipo === 'COMPRA') {
    orders[idx].tercNombre  = document.getElementById('ef-terc-nombre')?.value.trim() || '';
    orders[idx].tercDocTipo = ST.editTercDoc;
    orders[idx].tercDocNum  = document.getElementById('ef-terc-doc')?.value.trim() || '';
    orders[idx].hayTercero  = orders[idx].tercNombre ? 'S√≠' : 'No';
  }
  saveOrders(orders);
  const cfg = getConfig();
  if (cfg.scriptUrl) {
    sendToSheets('update', orders[idx], cfg.scriptUrl).catch(()=>{});
  }
  showToast('‚úì Cambios guardados');
  closeEdit();
  refreshHistorial();
}

function deleteFromEdit() {
  if (!confirm('¬øEliminar esta orden?')) return;
  deleteOrderById(ST.editingId);
  closeEdit();
  refreshHistorial();
}

function deleteOrderById(id) {
  const orders = getOrders();
  const o = orders.find(x => x.id === id);
  const filtered = orders.filter(x => x.id !== id);
  saveOrders(filtered);
  const cfg = getConfig();
  if (cfg.scriptUrl && o) {
    fetch(cfg.scriptUrl, {
      method:'POST', mode:'no-cors',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({action:'delete', orden: o.orden})
    }).catch(()=>{});
  }
  showToast('Orden eliminada');
}

function closeEdit() {
  document.getElementById('edit-overlay').classList.add('hidden');
  ST.editingId = null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadConfig() {
  const cfg = getConfig();
  if (cfg.scriptUrl) document.getElementById('cfg-url').value = cfg.scriptUrl;
  const dot = document.getElementById('sdot');
  const txt = document.getElementById('stext');
  if (!cfg.scriptUrl) { dot.className='sdot'; txt.textContent='Sin configurar'; }
  else { dot.className='sdot ok'; txt.textContent='Configurado'; }
  document.getElementById('cfg-count').textContent = getOrders().length;
}

async function saveConfig() {
  const url = document.getElementById('cfg-url').value.trim();
  if (!url) { showToast('Ingresa la URL del script'); return; }
  saveConfigData({scriptUrl: url});
  document.getElementById('sdot').className = 'sdot ok';
  document.getElementById('stext').textContent = 'Configurado';
  showToast('‚úì URL guardada');
}

function deleteLastOrder() {
  const orders = getOrders();
  if (!orders.length) { showToast('No hay √≥rdenes'); return; }
  if (!confirm(`¬øEliminar la √∫ltima orden? (${orders[0].orden})`)) return;
  deleteOrderById(orders[0].id);
  document.getElementById('cfg-count').textContent = getOrders().length;
}

function deleteAllOrders() {
  const orders = getOrders();
  if (!orders.length) { showToast('No hay √≥rdenes'); return; }
  if (!confirm(`¬øEliminar las ${orders.length} √≥rdenes? Esta acci√≥n no se puede deshacer.`)) return;
  const cfg = getConfig();
  if (cfg.scriptUrl) {
    fetch(cfg.scriptUrl, {
      method:'POST', mode:'no-cors',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({action:'deleteAll'})
    }).catch(()=>{});
  }
  saveOrders([]);
  showToast('Todas las √≥rdenes eliminadas');
  document.getElementById('cfg-count').textContent = 0;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function formatDate(d) {
  return d.toLocaleDateString('es-CO',{day:'2-digit',month:'2-digit',year:'numeric'});
}

let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
}

// Init
loadConfig();
</script>
</body>
</html>
