<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0D0D14">
<title>P2P Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* â•â•â• RESET & ROOT â•â•â• */
:root {
  --gold:#F0B90B; --gold-dim:rgba(240,185,11,0.12);
  --dark:#0D0D14; --panel:#13131E; --card:#1A1A2A; --card2:#1F1F32;
  --border:#252538; --border2:#2E2E48;
  --green:#00C97A; --green-dim:rgba(0,201,122,0.1);
  --red:#FF4E6A; --red-dim:rgba(255,78,106,0.1);
  --blue:#4A9EFF; --blue-dim:rgba(74,158,255,0.1);
  --orange:#FF9500; --orange-dim:rgba(255,149,0,0.1);
  --purple:#7B61FF; --purple-dim:rgba(123,97,255,0.1);
  --text:#F0F0FA; --text2:#A0A0C0; --text3:#606080;
  --radius:14px; --radius-sm:8px; --radius-lg:20px;
  --shadow:0 8px 32px rgba(0,0,0,0.4);
  --font:'DM Sans',sans-serif; --mono:'Space Mono',monospace;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;background:var(--dark);}
body{font-family:var(--font);color:var(--text);display:flex;flex-direction:column;
  max-width:430px;margin:0 auto;position:relative;}

/* â•â•â• SCREENS â•â•â• */
.screen{position:absolute;inset:0;display:flex;flex-direction:column;
  background:var(--dark);transition:transform 0.3s cubic-bezier(.4,0,.2,1),opacity 0.3s;
  will-change:transform;}
.screen.hidden{transform:translateX(100%);opacity:0;pointer-events:none;}
.screen.slide-left{transform:translateX(-30%);opacity:0;pointer-events:none;}

/* â•â•â• HEADER â•â•â• */
.header{background:var(--panel);padding:52px 18px 14px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:12px;flex-shrink:0;
  box-shadow:0 1px 0 var(--border);}
.header-back{width:36px;height:36px;background:var(--card);border-radius:var(--radius-sm);
  display:flex;align-items:center;justify-content:center;cursor:pointer;
  border:1px solid var(--border);font-size:16px;flex-shrink:0;}
.header-info{flex:1;}
.header-title{font-size:17px;font-weight:700;letter-spacing:-0.3px;}
.header-sub{font-size:11px;color:var(--text2);font-family:var(--mono);margin-top:1px;}
.header-logo{width:36px;height:36px;background:var(--gold);border-radius:10px;
  display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}

/* â•â•â• SCROLLABLE BODY â•â•â• */
.body{flex:1;overflow-y:auto;padding:16px 16px 100px;display:flex;flex-direction:column;gap:14px;
  scrollbar-width:none;-webkit-overflow-scrolling:touch;}
.body::-webkit-scrollbar{display:none;}

/* â•â•â• BOTTOM NAV â•â•â• */
.bottom-nav{position:absolute;bottom:0;left:0;right:0;
  background:var(--panel);border-top:1px solid var(--border);
  padding:10px 0 max(14px,env(safe-area-inset-bottom));
  display:flex;justify-content:space-around;z-index:100;
  box-shadow:0 -8px 24px rgba(0,0,0,0.3);}
.nav-btn{display:flex;flex-direction:column;align-items:center;gap:3px;
  cursor:pointer;padding:4px 20px;border-radius:var(--radius-sm);transition:opacity .2s;}
.nav-btn.active .nav-icon{color:var(--gold);}
.nav-btn.active .nav-label{color:var(--gold);}
.nav-icon{font-size:20px;color:var(--text3);}
.nav-label{font-size:9px;color:var(--text3);font-family:var(--mono);letter-spacing:.5px;}

/* â•â•â• COMPONENTS â•â•â• */

/* Cards */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;}
.card-title{font-size:11px;font-weight:700;color:var(--text2);letter-spacing:1.5px;
  text-transform:uppercase;font-family:var(--mono);margin-bottom:10px;}

/* Day summary */
.day-card{background:linear-gradient(135deg,#0a1a10 0%,#0a0d20 100%);
  border:1px solid var(--border);border-radius:var(--radius-lg);padding:18px;
  display:flex;flex-direction:column;gap:12px;}
.day-header{display:flex;justify-content:space-between;align-items:center;}
.day-label{font-size:10px;font-weight:700;color:var(--text2);letter-spacing:1.5px;
  text-transform:uppercase;font-family:var(--mono);display:flex;align-items:center;gap:6px;}
.pulse{width:7px;height:7px;border-radius:50%;background:var(--green);
  box-shadow:0 0 8px var(--green);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(.85)}}
.day-date{font-size:10px;color:var(--text3);font-family:var(--mono);}
.day-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.day-block{background:rgba(255,255,255,.03);border:1px solid var(--border);
  border-radius:var(--radius-sm);padding:12px;}
.day-block-lbl{font-size:9px;color:var(--text3);font-family:var(--mono);margin-bottom:5px;}
.day-block-val{font-size:15px;font-weight:700;}
.day-block-val.r{color:var(--red);}
.day-block-val.g{color:var(--green);}
.day-block-sub{font-size:9px;color:var(--text3);margin-top:2px;font-family:var(--mono);}
.tax-row{background:var(--orange-dim);border:1px solid rgba(255,149,0,.2);
  border-radius:var(--radius-sm);padding:10px 14px;
  display:flex;justify-content:space-between;align-items:center;}
.tax-lbl{font-size:10px;font-weight:600;color:var(--orange);font-family:var(--mono);}
.tax-val{font-size:13px;font-weight:700;color:var(--orange);}
.util-row{background:var(--green-dim);border:1px solid rgba(0,201,122,.2);
  border-radius:var(--radius-sm);padding:12px 14px;
  display:flex;justify-content:space-between;align-items:center;}
.util-lbl{font-size:10px;font-weight:700;color:var(--green);font-family:var(--mono);}
.util-val{font-size:18px;font-weight:700;color:var(--green);}

/* Section title */
.sec-title{font-size:11px;font-weight:700;color:var(--text3);letter-spacing:1.5px;
  text-transform:uppercase;font-family:var(--mono);display:flex;align-items:center;gap:8px;}
.sec-title::after{content:'';flex:1;height:1px;background:var(--border);}

/* Order card */
.order-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
  padding:14px;display:flex;flex-direction:column;gap:8px;position:relative;overflow:hidden;}
.order-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;}
.order-card.compra::before{background:var(--green);}
.order-card.venta::before{background:var(--red);}
.order-row1{display:flex;justify-content:space-between;align-items:center;}
.order-badges{display:flex;gap:6px;align-items:center;}
.badge{font-size:9px;font-weight:700;padding:3px 9px;border-radius:20px;font-family:var(--mono);}
.badge.c{background:rgba(0,201,122,.15);color:var(--green);}
.badge.v{background:rgba(255,78,106,.15);color:var(--red);}
.order-amount{font-size:15px;font-weight:700;}
.order-row2{display:flex;justify-content:space-between;align-items:center;}
.order-num{font-size:10px;color:var(--text3);font-family:var(--mono);}
.order-name{font-size:11px;font-weight:600;}
.order-chips{display:flex;gap:5px;flex-wrap:wrap;}
.chip{font-size:9px;padding:3px 8px;border-radius:6px;
  background:var(--card2);border:1px solid var(--border);
  color:var(--text2);font-family:var(--mono);}
.chip.warn{border-color:rgba(255,78,106,.3);color:rgba(255,78,106,.7);}

/* FAB */
.fab{position:absolute;bottom:80px;right:16px;
  width:52px;height:52px;background:var(--gold);border-radius:16px;
  display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:300;
  color:#000;box-shadow:0 6px 24px rgba(240,185,11,.45);cursor:pointer;z-index:50;
  transition:transform .15s,box-shadow .15s;}
.fab:active{transform:scale(.93);box-shadow:0 3px 12px rgba(240,185,11,.3);}

/* â•â•â• FORM SCREEN â•â•â• */
.form-body{flex:1;overflow-y:auto;padding:16px 16px 100px;
  display:flex;flex-direction:column;gap:14px;
  scrollbar-width:none;-webkit-overflow-scrolling:touch;}
.form-body::-webkit-scrollbar{display:none;}

/* Tipo selector */
.tipo-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.tipo-btn{background:var(--card);border:2px solid var(--border);border-radius:var(--radius);
  padding:14px;text-align:center;cursor:pointer;transition:all .2s;}
.tipo-btn:active{transform:scale(.97);}
.tipo-btn.sel.c{border-color:var(--green);background:var(--green-dim);}
.tipo-btn.sel.v{border-color:var(--red);background:var(--red-dim);}
.tipo-ico{font-size:22px;}
.tipo-lbl{font-size:12px;font-weight:700;margin-top:4px;color:var(--text2);}
.tipo-btn.sel.c .tipo-lbl{color:var(--green);}
.tipo-btn.sel.v .tipo-lbl{color:var(--red);}

/* Field */
.field{display:flex;flex-direction:column;gap:6px;}
.field-lbl{font-size:10px;font-weight:700;color:var(--text2);
  letter-spacing:1px;text-transform:uppercase;font-family:var(--mono);}
.field-hint{font-size:9px;color:var(--text3);font-family:var(--mono);margin-top:-2px;}
input.field-input{background:var(--card);border:1.5px solid var(--border);
  border-radius:var(--radius-sm);padding:13px 14px;font-size:15px;
  font-family:var(--font);color:var(--text);width:100%;outline:none;
  transition:border-color .2s;-webkit-appearance:none;}
input.field-input:focus{border-color:var(--gold);}
input.field-input::placeholder{color:var(--text3);}

/* Doc type */
.doc-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
.doc-btn{background:var(--card);border:2px solid var(--border);border-radius:var(--radius-sm);
  padding:10px 4px;text-align:center;font-size:11px;font-weight:700;
  color:var(--text3);font-family:var(--mono);cursor:pointer;transition:all .15s;}
.doc-btn:active{transform:scale(.95);}
.doc-btn.sel{border-color:var(--purple);color:var(--purple);background:var(--purple-dim);}

/* Divider */
.divider{display:flex;align-items:center;gap:10px;margin:2px 0;}
.div-line{flex:1;height:1px;background:var(--border);}
.div-label{font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;
  font-family:var(--mono);padding:4px 12px;border-radius:20px;white-space:nowrap;}
.div-label.exch{background:var(--blue-dim);color:var(--blue);border:1px solid rgba(74,158,255,.2);}
.div-label.terc{background:var(--gold-dim);color:var(--gold);border:1px solid rgba(240,185,11,.2);}
.div-label.mont{background:var(--green-dim);color:var(--green);border:1px solid rgba(0,201,122,.2);}

/* Toggle tercero */
.toggle-grid{display:flex;flex-direction:column;gap:8px;}
.toggle-opt{background:var(--card);border:2px solid var(--border);border-radius:var(--radius);
  padding:14px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all .2s;}
.toggle-opt:active{transform:scale(.98);}
.toggle-opt.sel-no{border-color:var(--text3);background:rgba(100,100,130,.07);}
.toggle-opt.sel-si{border-color:var(--gold);background:var(--gold-dim);}
.toggle-ico{font-size:22px;flex-shrink:0;}
.toggle-texts{display:flex;flex-direction:column;gap:2px;}
.toggle-name{font-size:12px;font-weight:700;}
.toggle-opt.sel-si .toggle-name{color:var(--gold);}
.toggle-opt.sel-no .toggle-name{color:var(--text3);}
.toggle-sub{font-size:10px;color:var(--text3);font-family:var(--mono);}

/* Tercero block */
.tercero-block{background:rgba(240,185,11,.04);border:1px solid rgba(240,185,11,.15);
  border-radius:var(--radius);padding:14px;display:flex;flex-direction:column;gap:12px;
  animation:fadeSlide .25s ease;}
.tercero-block.hidden{display:none;}
@keyframes fadeSlide{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}

/* Tax note */
.tax-note{background:var(--orange-dim);border:1px solid rgba(255,149,0,.2);
  border-radius:var(--radius-sm);padding:12px 14px;display:flex;gap:10px;align-items:flex-start;}
.tax-note-body{display:flex;flex-direction:column;gap:3px;}
.tax-note-title{font-size:10px;font-weight:700;color:var(--orange);font-family:var(--mono);}
.tax-note-val{font-size:13px;font-weight:700;color:var(--orange);}

/* Venta info */
.venta-info{background:var(--blue-dim);border:1px solid rgba(74,158,255,.2);
  border-radius:var(--radius-sm);padding:12px 14px;display:flex;gap:10px;align-items:center;}
.venta-info-text{font-size:10px;color:var(--blue);font-style:italic;line-height:1.4;}

/* Submit */
.submit-area{position:fixed;bottom:0;left:50%;transform:translateX(-50%);
  width:100%;max-width:430px;padding:12px 16px max(16px,env(safe-area-inset-bottom));
  background:linear-gradient(transparent, var(--dark) 30%);z-index:50;}
.submit-btn{width:100%;background:var(--gold);border:none;border-radius:var(--radius);
  padding:16px;font-size:15px;font-weight:700;color:#000;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:8px;
  font-family:var(--font);transition:transform .15s,box-shadow .15s;
  box-shadow:0 4px 20px rgba(240,185,11,.4);}
.submit-btn:active{transform:scale(.97);}
.submit-btn:disabled{background:#555;color:#888;cursor:not-allowed;box-shadow:none;}

/* â•â•â• HISTORIAL SCREEN â•â•â• */
.subtab-bar{display:flex;background:var(--panel);border-bottom:1px solid var(--border);flex-shrink:0;}
.subtab{flex:1;padding:13px 8px;text-align:center;font-size:11px;font-weight:700;
  color:var(--text3);font-family:var(--mono);cursor:pointer;
  border-bottom:2px solid transparent;transition:all .2s;letter-spacing:.5px;}
.subtab.active{color:var(--gold);border-bottom-color:var(--gold);}
.subpanel{display:none;flex:1;flex-direction:column;overflow:hidden;position:relative;}
.subpanel.active{display:flex;}

/* Search */
.search-wrap{padding:12px 16px;background:var(--panel);border-bottom:1px solid var(--border);}
.search-box{background:var(--card);border:1.5px solid var(--border);border-radius:var(--radius-sm);
  padding:11px 14px;display:flex;align-items:center;gap:10px;}
.search-box input{background:none;border:none;outline:none;font-size:13px;
  color:var(--text);font-family:var(--font);flex:1;width:100%;}
.search-box input::placeholder{color:var(--text3);}
.search-icon{font-size:16px;color:var(--text3);}

.results-list{flex:1;overflow-y:auto;padding:12px 16px 20px;
  display:flex;flex-direction:column;gap:8px;scrollbar-width:none;}
.results-list::-webkit-scrollbar{display:none;}
.results-count{font-size:9px;color:var(--text3);font-family:var(--mono);
  letter-spacing:1px;padding:2px 0 6px;}

.result-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
  padding:12px 14px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;
  transition:border-color .2s;}
.result-card:active{border-color:var(--gold);background:rgba(240,185,11,.03);}
.rc-left{display:flex;flex-direction:column;gap:3px;}
.rc-num{font-size:10px;color:var(--text3);font-family:var(--mono);}
.rc-name{font-size:13px;font-weight:600;}
.rc-meta{font-size:10px;color:var(--text3);font-family:var(--mono);}
.rc-right{display:flex;flex-direction:column;align-items:flex-end;gap:5px;}
.rc-amount{font-size:13px;font-weight:700;}

/* Edit overlay */
.edit-overlay{position:absolute;inset:0;background:var(--dark);
  display:flex;flex-direction:column;overflow:hidden;z-index:20;
  animation:slideUp .2s ease;}
.edit-overlay.hidden{display:none;}
@keyframes slideUp{from{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}
.edit-back{padding:14px 16px;background:var(--panel);border-bottom:1px solid var(--border);
  font-size:12px;color:var(--gold);font-family:var(--mono);cursor:pointer;
  display:flex;align-items:center;gap:6px;}
.edit-scroll{flex:1;overflow-y:auto;padding:14px 16px 100px;
  display:flex;flex-direction:column;gap:12px;scrollbar-width:none;}
.edit-scroll::-webkit-scrollbar{display:none;}
.edit-section{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
.edit-section.editable{border-color:rgba(240,185,11,.2);}
.edit-sec-title{padding:10px 14px;font-size:10px;font-weight:700;color:var(--text3);
  letter-spacing:1.5px;text-transform:uppercase;font-family:var(--mono);
  border-bottom:1px solid var(--border);background:rgba(255,255,255,.02);}
.edit-sec-title.e{color:var(--gold);}
.edit-row{display:flex;justify-content:space-between;align-items:center;
  padding:11px 14px;border-bottom:1px solid var(--border);}
.edit-row:last-child{border-bottom:none;}
.edit-row.ed{flex-direction:column;align-items:flex-start;gap:6px;padding:12px 14px;}
.edit-key{font-size:10px;color:var(--text3);font-family:var(--mono);}
.edit-val{font-size:12px;font-weight:600;}
.edit-val.g{color:var(--green);}
.edit-val.o{color:var(--orange);}
input.edit-field{background:rgba(240,185,11,.06);border:1px solid rgba(240,185,11,.2);
  border-radius:var(--radius-sm);padding:9px 12px;font-size:13px;
  font-family:var(--font);color:var(--text);width:100%;outline:none;}
input.edit-field:focus{border-color:var(--gold);}
.edit-doc-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;width:100%;}
.edit-doc-btn{background:var(--card2);border:2px solid var(--border);border-radius:6px;
  padding:8px 4px;text-align:center;font-size:10px;font-weight:700;
  color:var(--text3);font-family:var(--mono);cursor:pointer;}
.edit-doc-btn.sel{border-color:var(--purple);color:var(--purple);}
.edit-actions{display:flex;gap:10px;padding:0 14px 14px;}
.edit-save{flex:1;background:var(--gold);border:none;border-radius:var(--radius-sm);padding:13px;
  font-size:13px;font-weight:700;color:#000;cursor:pointer;font-family:var(--font);}
.edit-cancel{flex:1;background:var(--card2);border:1px solid var(--border);
  border-radius:var(--radius-sm);padding:13px;font-size:13px;font-weight:700;
  color:var(--text3);cursor:pointer;font-family:var(--font);}

/* â•â•â• TOAST â•â•â• */
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(20px);
  background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
  padding:12px 20px;font-size:13px;font-weight:600;display:flex;align-items:center;gap:8px;
  box-shadow:var(--shadow);opacity:0;transition:all .3s;z-index:999;white-space:nowrap;
  max-width:90%;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.toast.success{border-color:rgba(0,201,122,.4);color:var(--green);}
.toast.error{border-color:rgba(255,78,106,.4);color:var(--red);}
.toast.loading{border-color:rgba(240,185,11,.4);color:var(--gold);}

/* â•â•â• CONFIG SCREEN â•â•â• */
.config-item{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
  padding:16px;display:flex;flex-direction:column;gap:6px;}
.config-lbl{font-size:11px;font-weight:700;color:var(--text2);font-family:var(--mono);
  letter-spacing:1px;text-transform:uppercase;}
.config-hint{font-size:11px;color:var(--text3);line-height:1.5;}
input.config-input{background:var(--card2);border:1.5px solid var(--border);
  border-radius:var(--radius-sm);padding:12px 14px;font-size:13px;
  font-family:var(--mono);color:var(--text);width:100%;outline:none;
  transition:border-color .2s;margin-top:4px;}
input.config-input:focus{border-color:var(--gold);}
input.config-input::placeholder{color:var(--text3);}
.config-save{width:100%;background:var(--gold);border:none;border-radius:var(--radius);
  padding:15px;font-size:14px;font-weight:700;color:#000;cursor:pointer;
  font-family:var(--font);margin-top:4px;}
.status-indicator{display:flex;align-items:center;gap:8px;padding:10px 14px;
  background:var(--card2);border-radius:var(--radius-sm);}
.status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.status-dot.ok{background:var(--green);box-shadow:0 0 6px var(--green);}
.status-dot.bad{background:var(--red);}
.status-dot.none{background:var(--text3);}
.status-text{font-size:11px;font-family:var(--mono);color:var(--text2);}
.how-it-works{background:var(--blue-dim);border:1px solid rgba(74,158,255,.2);
  border-radius:var(--radius);padding:14px;}
.how-title{font-size:11px;font-weight:700;color:var(--blue);font-family:var(--mono);
  letter-spacing:1px;margin-bottom:8px;}
.how-step{font-size:11px;color:var(--text2);line-height:1.6;padding-left:4px;}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: RESUMEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="sc-resumen">
  <div class="header">
    <div class="header-logo">â‚¿</div>
    <div class="header-info">
      <div class="header-title">P2P Tracker</div>
      <div class="header-sub">BINANCE Â· COLOMBIA</div>
    </div>
  </div>

  <div class="body">
    <!-- Day summary -->
    <div class="day-card">
      <div class="day-header">
        <div class="day-label"><div class="pulse"></div>HOY</div>
        <div class="day-date" id="today-date">â€”</div>
      </div>
      <div class="day-grid">
        <div class="day-block">
          <div class="day-block-lbl">ğŸ’° COMPRADO</div>
          <div class="day-block-val r" id="sum-compra">$0</div>
          <div class="day-block-sub" id="cnt-compra">0 Ã³rdenes</div>
        </div>
        <div class="day-block">
          <div class="day-block-lbl">ğŸ’µ VENDIDO</div>
          <div class="day-block-val g" id="sum-venta">$0</div>
          <div class="day-block-sub" id="cnt-venta">0 Ã³rdenes</div>
        </div>
      </div>
      <div class="tax-row">
        <div class="tax-lbl">ğŸ›ï¸ 4Ã—1000 (compras)</div>
        <div class="tax-val" id="sum-tax">$0</div>
      </div>
      <div class="util-row">
        <div class="util-lbl">âœ¦ UTILIDAD NETA</div>
        <div class="util-val" id="sum-util">$0</div>
      </div>
    </div>

    <div class="sec-title">Ã“rdenes recientes</div>
    <div id="recent-list">
      <div style="text-align:center;color:var(--text3);font-size:13px;padding:32px 0;font-family:var(--mono);">
        Sin Ã³rdenes aÃºn.<br>Toca + para registrar la primera.
      </div>
    </div>
  </div>

  <div class="fab" onclick="goTo('sc-nueva')">ï¼‹</div>

  <div class="bottom-nav">
    <div class="nav-btn active" onclick="goTo('sc-resumen')">
      <div class="nav-icon">ğŸ“Š</div><div class="nav-label">RESUMEN</div>
    </div>
    <div class="nav-btn" onclick="goTo('sc-nueva')">
      <div class="nav-icon">ï¼‹</div><div class="nav-label">NUEVA</div>
    </div>
    <div class="nav-btn" onclick="goTo('sc-historial')">
      <div class="nav-icon">ğŸ“‹</div><div class="nav-label">HISTORIAL</div>
    </div>
    <div class="nav-btn" onclick="goTo('sc-config')">
      <div class="nav-icon">âš™ï¸</div><div class="nav-label">CONFIG</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: NUEVA ORDEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen hidden" id="sc-nueva">
  <div class="header">
    <div class="header-back" onclick="goTo('sc-resumen')">â†</div>
    <div class="header-info">
      <div class="header-title" id="nueva-title">Nueva Orden</div>
      <div class="header-sub" id="nueva-sub">COMPRA â€” REGISTRAR DATOS</div>
    </div>
  </div>

  <div class="form-body" id="form-body">

    <!-- Tipo -->
    <div class="field">
      <div class="field-lbl">Tipo de OperaciÃ³n</div>
      <div class="tipo-grid">
        <div class="tipo-btn sel c" id="btn-compra" onclick="setTipo('COMPRA')">
          <div class="tipo-ico">ğŸ“¥</div><div class="tipo-lbl">COMPRA</div>
        </div>
        <div class="tipo-btn v" id="btn-venta" onclick="setTipo('VENTA')">
          <div class="tipo-ico">ğŸ“¤</div><div class="tipo-lbl">VENTA</div>
        </div>
      </div>
    </div>

    <!-- NÂ° Orden -->
    <div class="field">
      <div class="field-lbl">NÂ° de Orden Binance</div>
      <input class="field-input" id="f-orden" type="text" placeholder="Ej: 20250224-0041" autocomplete="off">
    </div>

    <!-- Monto -->
    <div class="divider"><div class="div-line"></div><div class="div-label mont">ğŸ’° Monto</div><div class="div-line"></div></div>
    <div class="field">
      <div class="field-lbl">Monto de la TransacciÃ³n (COP)</div>
      <input class="field-input" id="f-monto" type="number" placeholder="Ej: 2060000" inputmode="numeric" oninput="updateTax()">
    </div>
    <div class="tax-note" id="tax-preview" style="display:none">
      <span style="font-size:18px">ğŸ›ï¸</span>
      <div class="tax-note-body">
        <div class="tax-note-title">4Ã—1000 CALCULADO AUTOMÃTICAMENTE</div>
        <div class="tax-note-val" id="tax-val-preview">$0</div>
      </div>
    </div>

    <!-- Titular Exchange -->
    <div class="divider"><div class="div-line"></div><div class="div-label exch">ğŸ¦ Titular del Exchange</div><div class="div-line"></div></div>
    <div class="field">
      <div class="field-lbl">Nombre en Binance</div>
      <div class="field-hint">Nombre tal como aparece en el perfil</div>
      <input class="field-input" id="f-exch-nombre" type="text" placeholder="Ej: juancarlos_p2p" autocomplete="off">
    </div>
    <div class="field">
      <div class="field-lbl">Tipo de Documento</div>
      <div class="doc-grid">
        <div class="doc-btn" data-group="exch" onclick="setDoc('exch','CC',this)">CC</div>
        <div class="doc-btn" data-group="exch" onclick="setDoc('exch','CE',this)">CE</div>
        <div class="doc-btn" data-group="exch" onclick="setDoc('exch','PPT',this)">PPT</div>
        <div class="doc-btn" data-group="exch" onclick="setDoc('exch','SD',this)">SD</div>
      </div>
    </div>
    <div class="field">
      <div class="field-lbl">NÃºmero de Documento</div>
      <input class="field-input" id="f-exch-doc" type="text" placeholder="Ej: 1098765432" autocomplete="off" inputmode="text">
    </div>

    <!-- Tercero toggle (solo COMPRA) -->
    <div id="tercero-section">
      <div class="divider"><div class="div-line"></div><div class="div-label terc">ğŸ‘¥ Â¿Hay Tercero?</div><div class="div-line"></div></div>
      <div class="toggle-grid">
        <div class="toggle-opt sel-no" id="tog-no" onclick="setTercero(false)">
          <div class="toggle-ico">ğŸš«</div>
          <div class="toggle-texts">
            <div class="toggle-name">No hay tercero</div>
            <div class="toggle-sub">El titular del Exchange recibe el pago</div>
          </div>
        </div>
        <div class="toggle-opt" id="tog-si" onclick="setTercero(true)">
          <div class="toggle-ico">ğŸ‘¥</div>
          <div class="toggle-texts">
            <div class="toggle-name">SÃ­ hay tercero</div>
            <div class="toggle-sub">El pago va a otra persona</div>
          </div>
        </div>
      </div>

      <div class="tercero-block hidden" id="tercero-fields">
        <div class="field">
          <div class="field-lbl">Nombre del Tercero</div>
          <div class="field-hint">Persona que recibe el pago</div>
          <input class="field-input" id="f-terc-nombre" type="text" placeholder="Nombre completo" autocomplete="off">
        </div>
        <div class="field">
          <div class="field-lbl">Tipo de Documento</div>
          <div class="doc-grid">
            <div class="doc-btn" data-group="terc" onclick="setDoc('terc','CC',this)">CC</div>
            <div class="doc-btn" data-group="terc" onclick="setDoc('terc','CE',this)">CE</div>
            <div class="doc-btn" data-group="terc" onclick="setDoc('terc','PPT',this)">PPT</div>
            <div class="doc-btn" data-group="terc" onclick="setDoc('terc','SD',this)">SD</div>
          </div>
        </div>
        <div class="field">
          <div class="field-lbl">NÃºmero de Documento</div>
          <input class="field-input" id="f-terc-doc" type="text" placeholder="Ej: PE123456" autocomplete="off" inputmode="text">
        </div>
      </div>
    </div>

    <!-- Venta info (hidden by default) -->
    <div class="venta-info hidden" id="venta-info">
      <span style="font-size:18px">â„¹ï¸</span>
      <div class="venta-info-text">En ventas solo se registra el titular del Exchange. No aplica tercero.</div>
    </div>

  </div>

  <div class="submit-area">
    <button class="submit-btn" id="submit-btn" onclick="submitOrder()">
      ğŸ’¾ Guardar en Google Sheets
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: HISTORIAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen hidden" id="sc-historial">
  <div class="header">
    <div class="header-back" onclick="goTo('sc-resumen')">â†</div>
    <div class="header-info">
      <div class="header-title">Historial</div>
      <div class="header-sub">Ã“RDENES REGISTRADAS</div>
    </div>
  </div>

  <div class="subtab-bar">
    <div class="subtab active" id="ht-ordenes" onclick="setHistTab('ordenes')">ğŸ“‹ Ã“rdenes</div>
    <div class="subtab" id="ht-editar" onclick="setHistTab('editar')">âœï¸ Editar Registro</div>
  </div>

  <!-- Sub: Ã“rdenes -->
  <div class="subpanel active" id="hp-ordenes">
    <div class="body" style="padding-bottom:20px" id="historial-list">
      <div style="text-align:center;color:var(--text3);font-size:13px;padding:32px 0;font-family:var(--mono);">
        Sin Ã³rdenes registradas.
      </div>
    </div>
  </div>

  <!-- Sub: Editar -->
  <div class="subpanel" id="hp-editar" style="position:relative;">
    <div class="search-wrap">
      <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" placeholder="NÂ° orden, nombre, documento..." id="search-input" oninput="doSearch()">
      </div>
    </div>
    <div class="results-list" id="search-results">
      <div class="results-count" id="search-count">HISTORIAL COMPLETO</div>
    </div>

    <!-- Edit overlay -->
    <div class="edit-overlay hidden" id="edit-overlay">
      <div class="edit-back" onclick="closeEdit()">â† Volver a resultados</div>
      <div class="edit-scroll" id="edit-scroll-content"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen hidden" id="sc-config">
  <div class="header">
    <div class="header-back" onclick="goTo('sc-resumen')">â†</div>
    <div class="header-info">
      <div class="header-title">ConfiguraciÃ³n</div>
      <div class="header-sub">CONEXIÃ“N CON GOOGLE SHEETS</div>
    </div>
  </div>
  <div class="body">

    <div class="how-it-works">
      <div class="how-title">ğŸ“‹ CÃ“MO FUNCIONA LA CONEXIÃ“N</div>
      <div class="how-step">1. Creas un Google Apps Script en tu Google Sheet</div>
      <div class="how-step">2. El script actÃºa como puente entre esta app y tu hoja</div>
      <div class="how-step">3. Pegas aquÃ­ la URL del script (Web App URL)</div>
      <div class="how-step">4. Cada orden se guarda directo en tu Excel en la nube</div>
    </div>

    <div class="config-item">
      <div class="config-lbl">ğŸ”— URL del Apps Script</div>
      <div class="config-hint">Pega aquÃ­ la URL de tu Google Apps Script desplegado como Web App. Sigue la guÃ­a paso a paso para obtenerla.</div>
      <input class="config-input" id="cfg-url" type="url" placeholder="https://script.google.com/macros/s/..." value="">
      <button class="config-save" onclick="saveConfig()">Guardar y verificar conexiÃ³n</button>
    </div>

    <div class="config-item">
      <div class="config-lbl">Estado de conexiÃ³n</div>
      <div class="status-indicator" id="status-indicator">
        <div class="status-dot none" id="status-dot"></div>
        <div class="status-text" id="status-text">Sin configurar</div>
      </div>
    </div>

    <div class="config-item">
      <div class="config-lbl">ğŸ“± Datos guardados localmente</div>
      <div class="config-hint" id="local-count">Cargando...</div>
      <button class="config-save" style="background:var(--red);color:white;margin-top:8px;" onclick="clearLocal()">
        Borrar datos locales
      </button>
    </div>

  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STATE = {
  tipo: 'COMPRA',
  exchDoc: '',
  tercDoc: '',
  hasTercero: false,
  editingOrder: null,
};

// Local storage key
const STORAGE_KEY = 'p2p_orders';
const CONFIG_KEY  = 'p2p_config';

function getOrders() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; }
}
function saveOrders(orders) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(orders));
}
function getConfig() {
  try { return JSON.parse(localStorage.getItem(CONFIG_KEY) || '{}'); } catch { return {}; }
}
function saveConfigData(cfg) {
  localStorage.setItem(CONFIG_KEY, JSON.stringify(cfg));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentScreen = 'sc-resumen';

function goTo(id) {
  const prev = document.getElementById(currentScreen);
  const next = document.getElementById(id);
  if (currentScreen === id) return;

  // Going back = slide right, else slide left
  const goingBack = ['sc-resumen'].includes(id);
  prev.classList.add(goingBack ? 'hidden' : 'slide-left');
  next.classList.remove('hidden', 'slide-left');
  currentScreen = id;

  // Update nav
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

  if (id === 'sc-resumen')  { document.querySelectorAll('.nav-btn')[0].classList.add('active'); refreshResumen(); }
  if (id === 'sc-nueva')    { document.querySelectorAll('.nav-btn')[1].classList.add('active'); resetForm(); }
  if (id === 'sc-historial'){ document.querySelectorAll('.nav-btn')[2].classList.add('active'); refreshHistorial(); }
  if (id === 'sc-config')   { document.querySelectorAll('.nav-btn')[3].classList.add('active'); loadConfig(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORM LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTipo(tipo) {
  STATE.tipo = tipo;
  const isCompra = tipo === 'COMPRA';
  document.getElementById('btn-compra').className = `tipo-btn ${isCompra ? 'sel c' : 'c'}`;
  document.getElementById('btn-venta').className  = `tipo-btn ${!isCompra ? 'sel v' : 'v'}`;
  document.getElementById('nueva-sub').textContent = `${tipo} â€” REGISTRAR DATOS`;
  document.getElementById('tercero-section').style.display = isCompra ? '' : 'none';
  document.getElementById('venta-info').classList.toggle('hidden', isCompra);
  document.getElementById('tax-preview').style.display = isCompra && document.getElementById('f-monto').value ? '' : 'none';
  updateTax();
}

function setDoc(group, val, el) {
  document.querySelectorAll(`[data-group="${group}"]`).forEach(b => b.classList.remove('sel'));
  el.classList.add('sel');
  if (group === 'exch') STATE.exchDoc = val;
  else STATE.tercDoc = val;
}

function setTercero(has) {
  STATE.hasTercero = has;
  document.getElementById('tog-si').className = `toggle-opt ${has ? 'sel-si' : ''}`;
  document.getElementById('tog-no').className = `toggle-opt ${!has ? 'sel-no' : ''}`;
  document.getElementById('tercero-fields').classList.toggle('hidden', !has);
}

function updateTax() {
  const monto = parseFloat(document.getElementById('f-monto').value) || 0;
  const isCompra = STATE.tipo === 'COMPRA';
  const tax = isCompra ? monto * 0.004 : 0;
  document.getElementById('tax-val-preview').textContent = formatCOP(tax);
  document.getElementById('tax-preview').style.display = isCompra && monto > 0 ? '' : 'none';
}

function resetForm() {
  STATE.tipo = 'COMPRA'; STATE.exchDoc = ''; STATE.tercDoc = ''; STATE.hasTercero = false;
  ['f-orden','f-monto','f-exch-nombre','f-exch-doc','f-terc-nombre','f-terc-doc']
    .forEach(id => document.getElementById(id).value = '');
  document.querySelectorAll('.doc-btn').forEach(b => b.classList.remove('sel'));
  document.querySelectorAll('.edit-doc-btn').forEach(b => b.classList.remove('sel'));
  setTipo('COMPRA');
  setTercero(false);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUBMIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitOrder() {
  const orden       = document.getElementById('f-orden').value.trim();
  const monto       = parseFloat(document.getElementById('f-monto').value) || 0;
  const exchNombre  = document.getElementById('f-exch-nombre').value.trim();
  const exchDoc     = STATE.exchDoc;
  const exchDocNum  = document.getElementById('f-exch-doc').value.trim();

  // Validations
  if (!orden)      { showToast('âš ï¸ Ingresa el NÂ° de orden', 'error'); return; }
  if (!monto)      { showToast('âš ï¸ Ingresa el monto', 'error'); return; }
  if (!exchNombre) { showToast('âš ï¸ Ingresa el nombre del titular', 'error'); return; }
  if (!exchDoc)    { showToast('âš ï¸ Selecciona el tipo de documento', 'error'); return; }
  if (!exchDocNum) { showToast('âš ï¸ Ingresa el NÂ° de documento', 'error'); return; }

  if (STATE.hasTercero) {
    if (!document.getElementById('f-terc-nombre').value.trim()) { showToast('âš ï¸ Ingresa el nombre del tercero', 'error'); return; }
    if (!STATE.tercDoc) { showToast('âš ï¸ Selecciona el tipo de doc del tercero', 'error'); return; }
    if (!document.getElementById('f-terc-doc').value.trim())    { showToast('âš ï¸ Ingresa el NÂ° de doc del tercero', 'error'); return; }
  }

  const now  = new Date();
  const tax  = STATE.tipo === 'COMPRA' ? monto * 0.004 : 0;
  const neto = STATE.tipo === 'COMPRA' ? monto - tax : monto;

  const order = {
    id:          Date.now(),
    fecha:       formatDateTime(now),
    orden:       orden,
    tipo:        STATE.tipo,
    monto:       monto,
    tax:         tax,
    neto:        neto,
    exchNombre:  exchNombre,
    exchDocTipo: exchDoc,
    exchDocNum:  exchDocNum,
    hayTercero:  STATE.hasTercero ? 'SÃ­' : 'No',
    tercNombre:  STATE.hasTercero ? document.getElementById('f-terc-nombre').value.trim() : '',
    tercDocTipo: STATE.hasTercero ? STATE.tercDoc : '',
    tercDocNum:  STATE.hasTercero ? document.getElementById('f-terc-doc').value.trim() : '',
  };

  // Check duplicate
  const orders = getOrders();
  if (orders.find(o => o.orden === orden)) {
    showToast('âš ï¸ Esta orden ya fue registrada', 'error'); return;
  }

  // Save locally first
  orders.unshift(order);
  saveOrders(orders);

  // Try to send to Google Sheets
  const btn = document.getElementById('submit-btn');
  btn.disabled = true;
  showToast('â³ Guardando...', 'loading');

  const cfg = getConfig();
  if (cfg.scriptUrl) {
    try {
      await sendToSheets(order, cfg.scriptUrl);
      showToast('âœ… Guardado en Google Sheets', 'success');
    } catch(e) {
      showToast('âœ… Guardado local (sin conexiÃ³n al Sheet)', 'success');
    }
  } else {
    showToast('âœ… Guardado localmente', 'success');
  }

  btn.disabled = false;
  setTimeout(() => goTo('sc-resumen'), 1200);
}

async function sendToSheets(order, url) {
  const row = [
    order.fecha, order.orden, order.tipo, order.monto,
    order.exchNombre, order.exchDocTipo, order.exchDocNum,
    order.hayTercero, order.tercNombre, order.tercDocTipo, order.tercDocNum,
    order.tax, order.neto
  ];
  const resp = await fetch(url, {
    method: 'POST',
    mode: 'no-cors',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ action: 'append', row })
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESUMEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshResumen() {
  const orders = getOrders();
  const today  = new Date().toLocaleDateString('es-CO', {day:'2-digit',month:'2-digit',year:'numeric'});
  document.getElementById('today-date').textContent =
    new Date().toLocaleDateString('es-CO',{weekday:'short',day:'numeric',month:'short'}).toUpperCase();

  const todayOrders = orders.filter(o => {
    const d = new Date(o.id);
    return d.toLocaleDateString('es-CO',{day:'2-digit',month:'2-digit',year:'numeric'}) === today;
  });

  const compras = todayOrders.filter(o => o.tipo === 'COMPRA');
  const ventas  = todayOrders.filter(o => o.tipo === 'VENTA');
  const sumComp = compras.reduce((s,o) => s + o.monto, 0);
  const sumVent = ventas.reduce((s,o) => s + o.monto, 0);
  const sumTax  = compras.reduce((s,o) => s + o.tax, 0);
  const util    = sumVent - sumComp - sumTax;

  document.getElementById('sum-compra').textContent = formatCOP(sumComp);
  document.getElementById('sum-venta').textContent  = formatCOP(sumVent);
  document.getElementById('sum-tax').textContent    = '-' + formatCOP(sumTax);
  document.getElementById('sum-util').textContent   = (util >= 0 ? '+' : '') + formatCOP(util);
  document.getElementById('cnt-compra').textContent = `${compras.length} orden${compras.length!==1?'es':''}`;
  document.getElementById('cnt-venta').textContent  = `${ventas.length} orden${ventas.length!==1?'es':''}`;

  // Recent list
  const container = document.getElementById('recent-list');
  if (orders.length === 0) {
    container.innerHTML = `<div style="text-align:center;color:var(--text3);font-size:13px;padding:32px 0;font-family:var(--mono);">Sin Ã³rdenes aÃºn.<br>Toca + para registrar la primera.</div>`;
    return;
  }
  container.innerHTML = orders.slice(0,10).map(renderOrderCard).join('');
}

function renderOrderCard(o) {
  const isC = o.tipo === 'COMPRA';
  const chips = [
    `<div class="chip">ğŸ¦ ${o.exchDocTipo} ${o.exchDocNum}</div>`,
    o.hayTercero === 'SÃ­' ? `<div class="chip">ğŸ‘¥ ${o.tercDocTipo} ${o.tercDocNum}</div>` : '',
  ].join('');
  return `
  <div class="order-card ${isC?'compra':'venta'}">
    <div class="order-row1">
      <div class="order-badges">
        <span class="badge ${isC?'c':'v'}">${o.tipo}</span>
      </div>
      <div class="order-amount">${formatCOP(o.monto)}</div>
    </div>
    <div class="order-row2">
      <div class="order-num">#${o.orden}</div>
      <div class="order-name">${o.exchNombre}</div>
    </div>
    <div class="order-chips">${chips}</div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORIAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshHistorial() {
  const orders = getOrders();
  const list = document.getElementById('historial-list');
  list.innerHTML = orders.length === 0
    ? `<div style="text-align:center;color:var(--text3);font-size:13px;padding:32px 0;font-family:var(--mono);">Sin Ã³rdenes registradas.</div>`
    : orders.map(renderOrderCard).join('');
  renderSearchResults(orders);
}

function setHistTab(tab) {
  ['ordenes','editar'].forEach(t => {
    document.getElementById(`ht-${t}`).classList.toggle('active', t===tab);
    document.getElementById(`hp-${t}`).classList.toggle('active', t===tab);
  });
  if (tab !== 'editar') closeEdit();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEARCH & EDIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doSearch() {
  const q = document.getElementById('search-input').value.toLowerCase().trim();
  const orders = getOrders();
  const filtered = q ? orders.filter(o =>
    o.orden.toLowerCase().includes(q) ||
    o.exchNombre.toLowerCase().includes(q) ||
    o.exchDocNum.toLowerCase().includes(q) ||
    o.tercNombre.toLowerCase().includes(q) ||
    o.tercDocNum.toLowerCase().includes(q)
  ) : orders;
  renderSearchResults(filtered);
}

function renderSearchResults(orders) {
  const container = document.getElementById('search-results');
  document.getElementById('search-count').textContent =
    `${orders.length} RESULTADO${orders.length!==1?'S':''}`;

  if (orders.length === 0) {
    container.innerHTML = `<div id="search-count" style="font-size:9px;color:var(--text3);font-family:var(--mono);letter-spacing:1px;">0 RESULTADOS</div>
    <div style="text-align:center;color:var(--text3);font-size:13px;padding:32px 0;font-family:var(--mono);">Sin resultados.</div>`;
    return;
  }

  const cards = orders.map(o => `
    <div class="result-card" onclick="openEdit(${o.id})">
      <div class="rc-left">
        <div class="rc-num">#${o.orden}</div>
        <div class="rc-name">${o.exchNombre}</div>
        <div class="rc-meta">${o.exchDocTipo} ${o.exchDocNum} Â· ${o.fecha.split(' ')[0]}</div>
      </div>
      <div class="rc-right">
        <div class="rc-amount">${formatCOP(o.monto)}</div>
        <span class="badge ${o.tipo==='COMPRA'?'c':'v'}">${o.tipo}</span>
      </div>
    </div>`).join('');

  container.innerHTML = `<div class="results-count">${orders.length} RESULTADO${orders.length!==1?'S':''}</div>${cards}`;
}

function openEdit(orderId) {
  const orders = getOrders();
  const o = orders.find(x => x.id === orderId);
  if (!o) return;
  STATE.editingOrder = o;

  const overlay = document.getElementById('edit-overlay');
  const scroll  = document.getElementById('edit-scroll-content');

  scroll.innerHTML = `
    <div class="edit-section">
      <div class="edit-sec-title">ğŸ“‹ Datos de la Orden</div>
      <div class="edit-row"><span class="edit-key">NÂ° Orden</span><span class="edit-val">#${o.orden}</span></div>
      <div class="edit-row"><span class="edit-key">Tipo</span><span class="edit-val ${o.tipo==='COMPRA'?'g':'edit-val'}" style="color:${o.tipo==='COMPRA'?'var(--green)':'var(--red)'}">${o.tipo}</span></div>
      <div class="edit-row"><span class="edit-key">Monto</span><span class="edit-val o">${formatCOP(o.monto)}</span></div>
      <div class="edit-row"><span class="edit-key">4Ã—1000</span><span class="edit-val" style="color:var(--orange)">${o.tipo==='COMPRA'?'-'+formatCOP(o.tax):'N/A'}</span></div>
      <div class="edit-row"><span class="edit-key">Fecha</span><span class="edit-val">${o.fecha}</span></div>
    </div>

    <div class="edit-section editable">
      <div class="edit-sec-title e">âœï¸ Titular del Exchange</div>
      <div class="edit-row ed">
        <span class="edit-key">Nombre</span>
        <input class="edit-field" id="ef-exch-nombre" value="${o.exchNombre}">
      </div>
      <div class="edit-row ed">
        <span class="edit-key">Tipo Documento</span>
        <div class="edit-doc-grid">
          ${['CC','CE','PPT','SD'].map(t=>`<div class="edit-doc-btn ${o.exchDocTipo===t?'sel':''}" onclick="editDocSel('exch','${t}',this)">${t}</div>`).join('')}
        </div>
      </div>
      <div class="edit-row ed">
        <span class="edit-key">NÂ° Documento</span>
        <input class="edit-field" id="ef-exch-doc" value="${o.exchDocNum}">
      </div>
    </div>

    ${o.tipo === 'COMPRA' ? `
    <div class="edit-section editable">
      <div class="edit-sec-title e">ğŸ‘¥ Tercero (si aplica)</div>
      <div class="edit-row ed">
        <span class="edit-key">Nombre</span>
        <input class="edit-field" id="ef-terc-nombre" value="${o.tercNombre}">
      </div>
      <div class="edit-row ed">
        <span class="edit-key">Tipo Documento</span>
        <div class="edit-doc-grid">
          ${['CC','CE','PPT','SD'].map(t=>`<div class="edit-doc-btn ${o.tercDocTipo===t?'sel':''}" onclick="editDocSel('terc','${t}',this)">${t}</div>`).join('')}
        </div>
      </div>
      <div class="edit-row ed">
        <span class="edit-key">NÂ° Documento</span>
        <input class="edit-field" id="ef-terc-doc" value="${o.tercDocNum}">
      </div>
    </div>` : ''}

    <div class="edit-actions">
      <button class="edit-save" onclick="saveEdit()">ğŸ’¾ Guardar cambios</button>
      <button class="edit-cancel" onclick="closeEdit()">Cancelar</button>
    </div>
  `;

  overlay.classList.remove('hidden');
}

function editDocSel(group, val, el) {
  const grid = el.parentElement;
  grid.querySelectorAll('.edit-doc-btn').forEach(b => b.classList.remove('sel'));
  el.classList.add('sel');
  if (group === 'exch') STATE.editingOrder.exchDocTipo = val;
  else STATE.editingOrder.tercDocTipo = val;
}

function saveEdit() {
  const o = STATE.editingOrder;
  const orders = getOrders();
  const idx = orders.findIndex(x => x.id === o.id);
  if (idx === -1) return;

  orders[idx].exchNombre  = document.getElementById('ef-exch-nombre').value.trim() || o.exchNombre;
  orders[idx].exchDocTipo = o.exchDocTipo;
  orders[idx].exchDocNum  = document.getElementById('ef-exch-doc').value.trim() || o.exchDocNum;
  if (o.tipo === 'COMPRA') {
    orders[idx].tercNombre  = (document.getElementById('ef-terc-nombre')?.value || '').trim();
    orders[idx].tercDocTipo = o.tercDocTipo;
    orders[idx].tercDocNum  = (document.getElementById('ef-terc-doc')?.value || '').trim();
    orders[idx].hayTercero  = orders[idx].tercNombre ? 'SÃ­' : 'No';
  }

  saveOrders(orders);

  // Sync to Sheets
  const cfg = getConfig();
  if (cfg.scriptUrl) {
    const row = [orders[idx].fecha, orders[idx].orden, orders[idx].tipo, orders[idx].monto,
      orders[idx].exchNombre, orders[idx].exchDocTipo, orders[idx].exchDocNum,
      orders[idx].hayTercero, orders[idx].tercNombre, orders[idx].tercDocTipo, orders[idx].tercDocNum,
      orders[idx].tax, orders[idx].neto];
    fetch(cfg.scriptUrl, {
      method:'POST', mode:'no-cors',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({action:'update', orden: orders[idx].orden, row})
    }).catch(()=>{});
  }

  showToast('âœ… Cambios guardados', 'success');
  closeEdit();
  refreshHistorial();
}

function closeEdit() {
  document.getElementById('edit-overlay').classList.add('hidden');
  STATE.editingOrder = null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadConfig() {
  const cfg = getConfig();
  if (cfg.scriptUrl) document.getElementById('cfg-url').value = cfg.scriptUrl;
  updateStatusDot(cfg.connected);
  const orders = getOrders();
  document.getElementById('local-count').textContent =
    `${orders.length} orden${orders.length!==1?'es':''} guardada${orders.length!==1?'s':''} localmente.`;
}

async function saveConfig() {
  const url = document.getElementById('cfg-url').value.trim();
  if (!url) { showToast('âš ï¸ Ingresa la URL del script', 'error'); return; }

  showToast('â³ Verificando conexiÃ³n...', 'loading');
  let connected = false;
  try {
    await fetch(url + '?test=1', {mode:'no-cors'});
    connected = true;
  } catch(e) { connected = false; }

  saveConfigData({scriptUrl: url, connected});
  updateStatusDot(connected);
  showToast(connected ? 'âœ… Conectado correctamente' : 'âš ï¸ Guardado (verifica la URL)', connected ? 'success' : 'error');
}

function updateStatusDot(connected) {
  const dot  = document.getElementById('status-dot');
  const text = document.getElementById('status-text');
  if (connected === undefined) {
    dot.className = 'status-dot none'; text.textContent = 'Sin configurar';
  } else if (connected) {
    dot.className = 'status-dot ok'; text.textContent = 'Conectado a Google Sheets';
  } else {
    dot.className = 'status-dot bad'; text.textContent = 'URL configurada (sin verificar)';
  }
}

function clearLocal() {
  if (!confirm('Â¿Seguro? Se borrarÃ¡n todos los datos locales.')) return;
  localStorage.removeItem(STORAGE_KEY);
  showToast('ğŸ—‘ï¸ Datos borrados', 'error');
  loadConfig();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function formatCOP(n) {
  return '$' + Math.round(n).toLocaleString('es-CO');
}
function formatDateTime(d) {
  return d.toLocaleDateString('es-CO',{day:'2-digit',month:'2-digit',year:'numeric'}) + ' ' +
         d.toLocaleTimeString('es-CO',{hour:'2-digit',minute:'2-digit'});
}

let toastTimer;
function showToast(msg, type='success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast show ${type}`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
refreshResumen();

// Set today date
document.getElementById('today-date').textContent =
  new Date().toLocaleDateString('es-CO',{weekday:'short',day:'numeric',month:'short'}).toUpperCase();
</script>
</body>
</html>
